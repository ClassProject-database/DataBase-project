{% extends "base.html" %}

{% block title %}{{ movie.title }} - Details{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card bg-dark text-white shadow-lg mb-4">
    <div class="row g-0">
      <div class="col-md-4">
        <img src="{{ url_for('static', filename='images/' ~ movie.image_path) }}"
             alt="{{ movie.title }}"
             class="img-fluid rounded-start"
             onerror="this.onerror=null;this.src='/static/images/keyboard.jpg';">
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h2 class="card-title">{{ movie.title }}</h2>
          <p><strong>Release Year:</strong> {{ movie.release_year }}</p>
          <p><strong>Rating:</strong> {{ movie.rating or "Not Rated" }}</p>
          <p><strong>Price:</strong> ${{ "%.2f"|format(movie.price) }}</p>

          {% if genres %}
            <p><strong>Genres:</strong></p>
            {% for genre in genres %}
              <span class="badge bg-primary me-1">{{ genre }}</span>
            {% endfor %}
          {% endif %}

          {% if movie.description %}
            <div class="bg-secondary bg-opacity-25 text-white rounded p-3 mt-3">
              {{ movie.description }}
            </div>
          {% else %}
            <div class="bg-secondary bg-opacity-25 text-muted rounded p-3 mt-3">
              No description available.
            </div>
          {% endif %}

          {% if movie.trailer_url %}
            <div class="mt-4">
              <a href="{{ movie.trailer_url }}" target="_blank" class="d-inline-block">
                <img src="https://img.youtube.com/vi/{{ movie.trailer_url.split('v=')[-1] }}/0.jpg" 
                     class="img-fluid rounded shadow border border-secondary" 
                     style="max-width: 100%; height: auto;"
                     alt="Watch trailer">
              </a>
              <p class="mt-2 text-white-50">Click image to watch trailer</p>
            </div>
          {% endif %}

          {% if current_user.is_authenticated and current_user.role == 'customer' %}
            <div class="mt-4">
              <button 
                class="btn btn-success add-to-cart-btn"
                data-movie-id="{{ movie.movie_id }}"
                data-title="{{ movie.title|e }}"
                data-price="{{ movie.price }}">
                <i class="fa fa-shopping-cart me-1"></i> Add to Cart
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-dark text-white shadow-lg">
    <div class="card-header border-bottom border-secondary">
      <h4 class="mb-0"><i class="fa fa-comments me-2"></i>User Reviews</h4>
    </div>
    <div class="card-body">
      {% if reviews %}
        <div class="list-group">
          {% for r in reviews %}
            <div class="list-group-item list-group-item-dark mb-3 rounded">
              <p class="mb-1"><strong>{{ r.username }}</strong> rated it ‚≠ê {{ r.rating }}</p>
              <p class="mb-1">{{ r.review_comment or "No comment." }}</p>
              <small class="text-muted">{{ r.review_date.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="bg-secondary bg-opacity-25 text-muted rounded p-3 text-center">
          No reviews for this movie yet.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!--Add to Cart Confirmation -->
<div id="cartModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-body text-center">
        <p class="fs-5"><i class="fa fa-check-circle text-success me-2"></i><span id="cartModalMsg"></span></p>
        <button type="button" class="btn btn-outline-light mt-2" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".add-to-cart-btn");
      if (!btn) return;

      const id = btn.dataset.movieId;
      const name = btn.dataset.title;
      const price = btn.dataset.price;

      if (typeof addToCart === "function") {
        addToCart(id, name, price);
        const modal = new bootstrap.Modal(document.getElementById("cartModal"));
        document.getElementById("cartModalMsg").textContent = `${name} added to your cart!`;
        modal.show();
      }
    });
  });
</script>
{% endblock %}
